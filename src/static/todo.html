<!DOCTYPE html>
<html lang="zh-hans">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta content="width=device-width, initial-scale=1, shrink-to-fit=no" name="viewport">
  <link rel="icon" type="image/x-icon" href="/favicon.ico">
  <title>Todo</title>
  <link rel="stylesheet" href="/css/main.css" crossorigin="">
  <link rel="stylesheet" href="/css/reset.css" crossorigin="">
  <script src="/js/htmx.js"></script>
  
<body>
<!--#content-->
  <div class="todo-container">
    <div class="todo-header">
      <h1>ğŸ“ æˆ‘çš„TODOåˆ—è¡¨</h1>
    </div>
    
    <div class="todo-content">
      <!-- æ·»åŠ è¡¨å• -->
      <form 
        hx-post="/add" 
        hx-target="#todo-list"
        hx-swap="innerHTML"
        hx-ext="json-enc"
      >
        <input type="text" name="todo" placeholder="æ–°çš„ä»»åŠ¡...">
        <button>æ·»åŠ </button>
      </form>
      
      <!-- è‡ªåŠ¨åŠ è½½todos -->
      <div 
        hx-get="/" 
        hx-trigger="load"
        hx-target="#todo-list"
      ></div>
      
      <!-- åˆ—è¡¨æ˜¾ç¤º -->
      <ul id="todo-list" hx-swap-oob="true"></ul>
    </div>
  </div>

  <script>
    document.body.addEventListener('htmx:beforeSwap', function(evt) {
      // å¦‚æœæ˜¯todosåˆ—è¡¨è¯·æ±‚
      if (evt.detail.xhr.responseURL.includes('/')) {
        try {
          const todos = JSON.parse(evt.detail.xhr.responseText);
          // ç”ŸæˆHTML
          const html = todos.map(todo => `
            <li class="todo-item" id="todo-${todo.id}">
              <input type="checkbox" 
                id = "${todo.id}"
                ${todo.status ? 'checked' : ''}
                hx-put="/todos/${todo.id}"
                hx-trigger="change"
                hx-target="#todo-${todo.id}"
                hx-swap="outerHTML">
              <label for="${todo.id}"><span class="${todo.status ? 'completed' : ''}">${todo.todo}</span></label>
            </li>
          `).join('');
          
          evt.detail.target.innerHTML = html || '<li>æš‚æ— ä»»åŠ¡</li>';
          evt.detail.shouldSwap = false;
        } catch(e) {
          console.error(e);
        }
      }
    });
  </script>
</body>
</html>

